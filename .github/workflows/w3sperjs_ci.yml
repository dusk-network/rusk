name: w3sper.js CI

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

jobs:
  # JOB to run change detection
  changes:
    runs-on: core
    # Required permissions
    permissions:
      pull-requests: read
    # Set job outputs to values from filter step
    outputs:
      run-ci: ${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.run-ci }}
    steps:
      # For pull requests it's not necessary to checkout the code
      - uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name != 'workflow_dispatch'
        with:
          filters: |
            run-ci:
              - 'execution-core/**'
              - 'wallet-core/**'
              - 'w3sper.js/**'
              - '.github/workflows/w3sperjs_ci.yml'

  w3sper_test:
    needs: changes
    if: needs.changes.outputs.run-ci == 'true' && (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch')
    name: "Run w3sper tests"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Docker container
        run: |
          mkdir -p /opt/rusk
          docker run --name rusk -d -e RUSK_MINIMUM_BLOCK_TIME=1 -p 9000:9000/udp -p 8080:8080/tcp -v ./w3sper.js/tests/assets/genesis.toml:/opt/rusk/state.toml dusknode/rusk

      - name: Wait for Rusk node
        run: |
          for i in $(seq 1 30); do
            if curl -sf -X POST -H 'Content-Type: application/json' -d '{"query":"{ block(height: 0) { header { height } } }"}' http://localhost:8080/graphql > /dev/null 2>&1; then
              echo "Rusk node ready"
              exit 0
            fi
            echo "Waiting for Rusk node... ($i/30)"
            sleep 2
          done
          echo "Rusk node failed to start"
          docker logs rusk
          exit 1

      - name: Setup Rust
        uses: dsherret/rust-toolchain-file@v1

      - name: Setup deno
        uses: denoland/setup-deno@v2
        with: 
          deno-version: v2.x
        
      - name: Run deno
        run: |
          cd w3sper.js
          deno task wasm
          deno task test
